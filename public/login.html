<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Maid – Email Login</title>
    <style>
      :root {
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "Segoe UI",
          sans-serif;
        color: #0f172a;
        background: #f8fafc;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        padding: 2rem;
      }

      main {
        width: min(360px, 100%);
      }

      h1 {
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
      }

      p {
        margin: 0 0 1rem;
        color: #475569;
        font-size: 0.95rem;
      }

      form,
      section {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      label {
        font-size: 0.9rem;
      }

      input,
      button {
        font: inherit;
        padding: 0.65rem 0.75rem;
        border-radius: 0.4rem;
      }

      input {
        border: 1px solid #cbd5f5;
      }

      button {
        border: 1px solid #2563eb;
        background: #2563eb;
        color: #fff;
        cursor: pointer;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .status {
        min-height: 1.25rem;
        font-size: 0.85rem;
      }

      .status.error {
        color: #dc2626;
      }

      .status.success {
        color: #15803d;
      }

      .session-output {
        padding: 0.75rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.4rem;
        background: #fff;
        font-size: 0.85rem;
        overflow-x: auto;
        max-height: 12rem;
      }
    </style>
  </head>
  <body>
    <main>
      <h1>Email sign-in</h1>
      <p>Use the Maid credentials provided to you.</p>
      <form id="email-login-form">
        <label for="email">Email address</label>
        <input
          id="email"
          name="email"
          type="email"
          placeholder="you@example.com"
          required
        />
        <label for="password">Password</label>
        <input
          id="password"
          name="password"
          type="password"
          placeholder="••••••••"
          minlength="8"
          required
        />
        <button type="submit">Sign in</button>
        <p class="status" id="status" role="status" aria-live="polite"></p>
      </form>
      <section class="session-panel" id="session-panel" hidden>
        <h2>Current session</h2>
        <pre
          class="session-output"
          id="session-output"
          aria-live="polite"
        ></pre>
      </section>
    </main>

    <script>
      const AUTH_API_URL = "%AUTH_API_URL%";
      const EMAIL_SIGNIN_URL = `${AUTH_API_URL.replace(/\/$/, "")}/sign-in/email`;

      const form = document.getElementById("email-login-form");
      const statusEl = document.getElementById("status");
      const submitBtn = form.querySelector("button[type=submit]");
      const sessionPanel = document.getElementById("session-panel");
      const sessionOutput = document.getElementById("session-output");

      function setStatus(message, type = "") {
        statusEl.textContent = message;
        statusEl.className = `status ${type}`.trim();
      }

      function clearSession() {
        sessionPanel.hidden = true;
        sessionOutput.textContent = "";
      }

      function renderSession(session) {
        sessionPanel.hidden = false;
        sessionOutput.textContent = JSON.stringify(session, null, 2);
      }

      async function fetchSession(token) {
        const response = await fetch("/api/session", {
          headers: {
            Authorization: `Bearer ${token}`,
            Accept: "application/json",
          },
          credentials: "include",
        });

        const payload = await response.json().catch(() => null);
        if (!response.ok) {
          const message =
            (payload && (payload.error || payload.message)) ||
            `Unable to load session (${response.status})`;
          throw new Error(message);
        }

        renderSession(payload);
        return payload;
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const emailInput = form.email;
        const email = emailInput.value.trim();
        const password = form.password.value;
        if (!email) {
          setStatus("Email is required", "error");
          emailInput.focus();
          return;
        }
        if (!password) {
          setStatus("Password is required", "error");
          form.password.focus();
          return;
        }

        submitBtn.disabled = true;
        setStatus("Signing you in…");
        clearSession();

        try {
          const response = await fetch(EMAIL_SIGNIN_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify({ email, password }),
            credentials: "include",
          });
          const responseBody = await response.json().catch(() => null);

          if (!response.ok) {
            const message =
              (responseBody && (responseBody.error || responseBody.message)) ||
              `Unable to sign in (${response.status})`;
            throw new Error(message);
          }

          const tokenHeader = response.headers.get("set-auth-token");
          const token = tokenHeader ? tokenHeader.trim() : "";
          if (!token) {
            throw new Error(
              "Signed in successfully, but auth token header was missing.",
            );
          }

          form.reset();
          setStatus("Signed in! Fetching session…", "success");

          try {
            await fetchSession(token);
            setStatus("Signed in! Session details are shown below.", "success");
          } catch (sessionError) {
            clearSession();
            throw sessionError;
          }
        } catch (error) {
          console.error("Sign-in flow failed", error);
          clearSession();
          setStatus(error.message || "Something went wrong", "error");
        } finally {
          submitBtn.disabled = false;
        }
      });
    </script>
  </body>
</html>
